<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sticker Web Component Demo</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #fff;
        }

        h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 2rem;
            color: #8b8b9a;
        }

        h2 {
            margin: 2rem 0 1rem;
            font-size: 1.25rem;
            color: #a0a0b0;
        }

        /* Demo sections */
        .demo-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Single card demo */
        .single-card {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }

        .card-container {
            width: 200px;
            height: 320px;
        }

        .controls {
            flex: 1;
        }

        .control-group {
            margin-bottom: 1rem;
        }

        .control-group.url-input.hidden {
            display: none;
        }

        label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: #a0a0b0;
        }

        select, input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            background: #1a1a2e;
            color: #fff;
            font-size: 0.875rem;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Checkbox group */
        .checkbox-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox-label input {
            width: 18px;
            height: 18px;
        }

        /* Grid demo */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .card-grid sticker-card {
            width: 100%;
            cursor: pointer;
        }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }
        .overlay.active {
            display: flex;
        }
        .overlay-card {
            height: 85vh;
            aspect-ratio: 5/8;
        }
        .overlay-card sticker-card {
            width: 100%;
            height: 100%;
        }

        /* Code example */
        pre {
            background: #0d0d1a;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        code {
            color: #a5d6ff;
        }

        .code-comment {
            color: #6e7681;
        }

        .code-string {
            color: #a5d6ff;
        }

        .code-tag {
            color: #7ee787;
        }

        .code-attr {
            color: #79c0ff;
        }
    </style>
</head>
<body>
    <!-- Overlay for expanded card view -->
    <div class="overlay" id="overlay">
        <div class="overlay-card" id="overlay-card"></div>
    </div>

    <h1>&lt;sticker-card&gt;</h1>
    <p class="subtitle">WebGL Card Shader Web Component</p>

    <!-- Demo 1: Interactive single card -->
    <div class="demo-section">
        <h2>Interactive Demo</h2>
        <div class="single-card">
            <div class="card-container">
                <sticker-card
                    id="demo-card"
                    shader="holographic"
                    card-src="src/textures/zelda/visual.png"
                    card-normal="src/textures/zelda/normal.png"
                    card-name="Link"
                    card-number="001/100"
                    mask="normal"
                    interactive
                ></sticker-card>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label for="shader-select">Shader Effect</label>
                    <select id="shader-select">
                        <option value="holographic" selected>Holographic</option>
                        <option value="foil">Foil</option>
                        <option value="parallax">Parallax</option>
                        <option value="galaxy">Galaxy</option>
                        <option value="cracked-ice">Cracked Ice</option>
                        <option value="refractor">Refractor</option>
                        <option value="starburst">Starburst</option>
                        <option value="prizm">Prizm</option>
                        <option value="etched">Etched</option>
                        <option value="base">Base (no effect)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="card-src-select">Card Source</label>
                    <select id="card-src-select">
                        <option value="custom" selected>Custom URL</option>
                        <option value="random-emoji">Random Emoji</option>
                        <option value="random-geometric">Random Geometric</option>
                    </select>
                </div>

                <div class="control-group url-input" id="visual-url-group">
                    <label for="card-src-url">Visual URL</label>
                    <input type="text" id="card-src-url" value="src/textures/zelda/visual.png" placeholder="URL to card image">
                </div>

                <div class="control-group url-input" id="normal-url-group">
                    <label for="card-normal-url">Normal Map URL (optional)</label>
                    <input type="text" id="card-normal-url" value="src/textures/zelda/normal.png" placeholder="URL to normal map">
                </div>

                <div class="control-group">
                    <label for="mask-select">Effect Mask</label>
                    <select id="mask-select">
                        <option value="full">Full</option>
                        <option value="border">Border</option>
                        <option value="center">Center</option>
                        <option value="art-window">Art Window</option>
                        <option value="radial-edge">Radial Edge</option>
                        <option value="radial-center">Radial Center</option>
                        <option value="normal" selected>Normal Map</option>
                        <option value="brightness">Texture Brightness</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="card-collection">Collection Name</label>
                    <input type="text" id="card-collection" value="">
                </div>

                <div class="control-group">
                    <label for="card-name">Card Name</label>
                    <input type="text" id="card-name" value="Link">
                </div>

                <div class="control-group">
                    <label for="card-number">Card Number</label>
                    <input type="text" id="card-number" value="001/100">
                </div>

            </div>
        </div>
    </div>

    <!-- Demo 2: Lazy loading grid -->
    <div class="demo-section">
        <h2>Lazy Loading Grid (hover to activate)</h2>
        <div class="card-grid" id="lazy-grid">
            <!-- Cards will be added via JavaScript -->
        </div>
    </div>

    <!-- Demo 3: Code example -->
    <div class="demo-section">
        <h2>Usage</h2>
        <pre><code><span class="code-comment">&lt;!-- Import the library --&gt;</span>
<span class="code-tag">&lt;script</span> <span class="code-attr">type</span>=<span class="code-string">"module"</span><span class="code-tag">&gt;</span>
  import { registerstickerElement } from './src/index.js'
  registerstickerElement()
<span class="code-tag">&lt;/script&gt;</span>

<span class="code-comment">&lt;!-- Use the web component --&gt;</span>
<span class="code-tag">&lt;sticker-card</span>
  <span class="code-attr">shader</span>=<span class="code-string">"holographic"</span>
  <span class="code-attr">card-src</span>=<span class="code-string">"path/to/card.png"</span>
  <span class="code-attr">card-normal</span>=<span class="code-string">"path/to/normal.png"</span>
  <span class="code-attr">card-name</span>=<span class="code-string">"Card"</span>
  <span class="code-attr">card-number</span>=<span class="code-string">"001/100"</span>
  <span class="code-attr">card-collection</span>=<span class="code-string">"Collection"</span>
  <span class="code-attr">mask</span>=<span class="code-string">"normal"</span>
  <span class="code-attr">interactive</span>
<span class="code-tag">&gt;&lt;/sticker-card&gt;</span>

<span class="code-comment">&lt;!-- Lazy loading (for many cards) --&gt;</span>
<span class="code-tag">&lt;sticker-card</span>
  <span class="code-attr">lazy</span>
  <span class="code-attr">lazy-margin</span>=<span class="code-string">"200"</span>
  <span class="code-attr">shader</span>=<span class="code-string">"foil"</span>
  <span class="code-attr">card-src</span>=<span class="code-string">"random-emoji"</span>
<span class="code-tag">&gt;&lt;/sticker-card&gt;</span>

<span class="code-comment">&lt;!-- All available attributes --&gt;</span>
<span class="code-comment">&lt;!-- shader: holographic|foil|parallax|galaxy|cracked-ice|refractor|starburst|prizm|etched|base --&gt;</span>
<span class="code-comment">&lt;!-- card-src: URL or "random-emoji" or "random-geometric" --&gt;</span>
<span class="code-comment">&lt;!-- card-normal: URL to normal map (optional) --&gt;</span>
<span class="code-comment">&lt;!-- card-name: Display name on card --&gt;</span>
<span class="code-comment">&lt;!-- card-number: Card number (e.g., "001/100") --&gt;</span>
<span class="code-comment">&lt;!-- card-collection: Collection name --&gt;</span>
<span class="code-comment">&lt;!-- mask: full|border|center|art-window|radial-edge|radial-center|normal|brightness --&gt;</span>
<span class="code-comment">&lt;!-- interactive: Enable mouse/touch interaction (boolean) --&gt;</span>
<span class="code-comment">&lt;!-- lazy: Defer WebGL init until hover (boolean) --&gt;</span>
<span class="code-comment">&lt;!-- lazy-margin: Pixels before viewport to start rendering (default: 200) --&gt;</span>
<span class="code-comment">&lt;!-- autoplay: Auto-start animation (default: true) --&gt;</span>
<span class="code-comment">&lt;!-- bloom: Enable bloom effect (boolean) --&gt;</span>
</code></pre>
    </div>

    <script type="module">
        import { sticker, registerstickerElement } from './src/index.js'

        // Register the web component
        registerstickerElement()

        // Wait for DOM
        document.addEventListener('DOMContentLoaded', () => {
            const demoCard = document.getElementById('demo-card')

            // Overlay state (declared early so event handlers can access)
            const overlay = document.getElementById('overlay')
            const overlayCardContainer = document.getElementById('overlay-card')
            let currentOverlayCard = null
            let currentSourceElement = null

            // Shader select
            document.getElementById('shader-select').addEventListener('change', (e) => {
                demoCard.setAttribute('shader', e.target.value)
                if (currentOverlayCard && currentSourceElement === demoCard) {
                    currentOverlayCard.setAttribute('shader', e.target.value)
                }
            })

            // URL input elements
            const srcUrlInput = document.getElementById('card-src-url')
            const normalUrlInput = document.getElementById('card-normal-url')
            const srcSelect = document.getElementById('card-src-select')
            const visualUrlGroup = document.getElementById('visual-url-group')
            const normalUrlGroup = document.getElementById('normal-url-group')

            // Show/hide URL inputs based on preset
            function updateUrlVisibility() {
                const isCustom = srcSelect.value === 'custom'
                visualUrlGroup.classList.toggle('hidden', !isCustom)
                normalUrlGroup.classList.toggle('hidden', !isCustom)
            }

            // Apply card source based on current selection
            function applyCardSource() {
                // Clear error styling
                srcUrlInput.style.borderColor = ''
                normalUrlInput.style.borderColor = ''

                const preset = srcSelect.value
                if (preset === 'custom') {
                    const src = srcUrlInput.value.trim()
                    const normal = normalUrlInput.value.trim()
                    if (src) {
                        demoCard.setAttribute('card-src', src)
                    }
                    if (normal) {
                        demoCard.setAttribute('card-normal', normal)
                    } else {
                        demoCard.removeAttribute('card-normal')
                    }
                    // Clear collection and reset card name to default for custom URLs
                    document.getElementById('card-collection').value = ''
                    demoCard.setAttribute('card-collection', '')
                    document.getElementById('card-name').value = 'Link'
                    demoCard.setAttribute('card-name', 'Link')
                    demoCard.setAttribute('card-number', document.getElementById('card-number').value)
                } else {
                    // random-emoji or random-geometric
                    demoCard.setAttribute('card-src', preset)
                    demoCard.removeAttribute('card-normal')
                }
            }

            // Card source preset select
            srcSelect.addEventListener('change', () => {
                updateUrlVisibility()
                applyCardSource()
            })

            // Manual URL input - apply on blur
            srcUrlInput.addEventListener('blur', applyCardSource)
            normalUrlInput.addEventListener('blur', applyCardSource)

            // Listen for load errors
            demoCard.addEventListener('sticker:error', (e) => {
                srcUrlInput.style.borderColor = 'red'
                normalUrlInput.style.borderColor = 'red'
                console.error('Card load error:', e.detail.error)
            })

            // Update card name and collection when random content generates them
            function updateGeneratedContent(e) {
                // Only handle events from the demo card itself, not bubbled events
                if (e.target !== demoCard) return

                if (srcSelect.value !== 'custom') {
                    const generatedName = demoCard.generatedName
                    const generatedCollection = demoCard.generatedCollection

                    if (generatedName) {
                        document.getElementById('card-name').value = generatedName
                        demoCard.setAttribute('card-name', generatedName)
                    }
                    if (generatedCollection) {
                        document.getElementById('card-collection').value = generatedCollection
                        demoCard.setAttribute('card-collection', generatedCollection)
                    }
                }
            }
            demoCard.addEventListener('sticker:ready', updateGeneratedContent)
            demoCard.addEventListener('sticker:source-loaded', updateGeneratedContent)

            // Mask select
            document.getElementById('mask-select').addEventListener('change', (e) => {
                demoCard.setAttribute('mask', e.target.value)
                // Explicitly sync to overlay (MutationObserver backup)
                if (currentOverlayCard && currentSourceElement === demoCard) {
                    currentOverlayCard.setAttribute('mask', e.target.value)
                }
            })

            // Card collection input
            document.getElementById('card-collection').addEventListener('input', (e) => {
                demoCard.setAttribute('card-collection', e.target.value)
            })

            // Card name input
            document.getElementById('card-name').addEventListener('input', (e) => {
                demoCard.setAttribute('card-name', e.target.value)
            })

            // Card number input
            document.getElementById('card-number').addEventListener('input', (e) => {
                demoCard.setAttribute('card-number', e.target.value)
            })

            // Overlay manager
            function openOverlay(config, sourceElement) {
                currentSourceElement = sourceElement
                overlay.classList.add('active')
                const card = document.createElement('sticker-card')
                card.setAttribute('shader', config.shader)
                card.setAttribute('card-src', config.src)
                if (config.normal) {
                    card.setAttribute('card-normal', config.normal)
                }
                if (config.cardName) {
                    card.setAttribute('card-name', config.cardName)
                }
                if (config.cardCollection) {
                    card.setAttribute('card-collection', config.cardCollection)
                }
                if (config.mask) {
                    card.setAttribute('mask', config.mask)
                }
                card.setAttribute('card-number', config.cardNumber)
                card.setAttribute('interactive', '')
                overlayCardContainer.innerHTML = ''
                overlayCardContainer.appendChild(card)
                currentOverlayCard = card
                // Copy content for random sources
                if (sourceElement) {
                    card.copyContentFrom(sourceElement)
                }
            }

            function closeOverlay() {
                overlay.classList.remove('active')
                if (currentOverlayCard) {
                    currentOverlayCard.remove()
                    currentOverlayCard = null
                }
                currentSourceElement = null
            }

            // Sync demo card changes to overlay when open
            function syncToOverlay(attrName, value) {
                if (!currentOverlayCard || currentSourceElement !== demoCard) return
                if (value !== null && value !== undefined) {
                    currentOverlayCard.setAttribute(attrName, value)
                } else {
                    currentOverlayCard.removeAttribute(attrName)
                }
                // For random sources, copy the generated content
                if (attrName === 'card-src' && value?.startsWith('random-')) {
                    // Wait for source to load then copy content
                    setTimeout(() => {
                        currentOverlayCard?.copyContentFrom(demoCard)
                    }, 100)
                }
            }

            // Watch for attribute changes on demo card
            const demoCardObserver = new MutationObserver((mutations) => {
                for (const mutation of mutations) {
                    if (mutation.type === 'attributes') {
                        const value = demoCard.getAttribute(mutation.attributeName)
                        syncToOverlay(mutation.attributeName, value)
                    }
                }
            })
            demoCardObserver.observe(demoCard, { attributes: true, attributeOldValue: true })

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeOverlay()
            })

            // Make demo card clickable to open in overlay
            demoCard.style.cursor = 'pointer'
            demoCard.addEventListener('click', () => {
                const config = {
                    shader: demoCard.getAttribute('shader'),
                    src: demoCard.getAttribute('card-src'),
                    normal: demoCard.getAttribute('card-normal'),
                    cardName: demoCard.getAttribute('card-name'),
                    cardNumber: demoCard.getAttribute('card-number'),
                    cardCollection: demoCard.getAttribute('card-collection'),
                    mask: demoCard.getAttribute('mask')
                }
                openOverlay(config, demoCard)
            })

            // Create lazy loading grid
            const grid = document.getElementById('lazy-grid')
            const shaders = sticker.shaderNames
            const sources = [
                { src: 'random-emoji', normal: null },
                { src: 'random-geometric', normal: null }
            ]

            for (let i = 0; i < 12; i++) {
                const card = document.createElement('sticker-card')
                const source = sources[i % sources.length]
                const config = {
                    shader: shaders[i % shaders.length],
                    src: source.src,
                    normal: source.normal,
                    cardNumber: `${String(i + 1).padStart(3, '0')}/012`
                }
                card.setAttribute('lazy', '')
                card.setAttribute('shader', config.shader)
                card.setAttribute('card-src', config.src)
                if (config.normal) {
                    card.setAttribute('card-normal', config.normal)
                }
                card.setAttribute('card-number', config.cardNumber)
                card.setAttribute('interactive', '')
                card.addEventListener('click', () => openOverlay(config, card))
                grid.appendChild(card)
            }
        })
    </script>
</body>
</html>
